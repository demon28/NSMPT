
@{
    ViewBag.Title = "Index";

}


@section HtmlHead{

    <script src="~/Reference/adminLTE/bower_components/ckeditor/ckeditor.js"></script>
    <link href="~/Reference/css/nsmpt.css" rel="stylesheet" />
}



@section Pageheader{
    <h1>
        <small>  Write E-Mail</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Mailbox</li>
    </ol>

}


<section class="content">

    <div class="row">
        <div class="col-md-3">
            <div class="box box-info" id="app">

                <div class="box-header with-border">
                    <h3 class="box-title">User Account</h3>
                 
                </div>

                <div class="box-body table-responsive ">

                    <ul class="list-group">
                        <li class="list-group-item" v-for="item in AccountItems">

                            <b>{{item.Account}}</b>&nbsp;&nbsp;
                          
                            <button type="button" class="btn bg-primary  btn-xs pull-right " v-on:click="AccountUse(item)">Use</button>
                        </li>

                    </ul>


                </div>
                <!-- /.box-body -->
            </div>
            <!-- /.box -->
            <!-- About Me Box -->

            <div class="box box-warning">
                <div class="box-header">
                    <h3 class="box-title">Template List</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>

                </div>
                <!-- /.box-header -->
                <div class="box-body table-responsive " id="App_Temp">
                    <table class="table table-hover" id="tab_contact">
                        <tbody>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th class="text-right"></th>
                            </tr>
                            <tr v-for="(item,index) in Data">
                                <td>{{item.MtId}}</td>
                                <td>{{item.TempName}}</td>
                                <td class="text-right">
                                    <button type="button" class="btn bg-purple  btn-xs " v-on:click="useitem(item)">Use</button>  &nbsp; &nbsp;
                                </td>
                            </tr>

                        </tbody>
                    </table>
                </div>
                <div class="box-footer">

                </div>
                <!-- /.box-body -->
            </div>

            <!-- /.box -->
        </div>
        <!-- /.col -->
        <div class="col-md-9">
            <div class="box box-success">
                <div class="box-header">

                    <div class="form-inline">
                        <button type="button" id="btn_send" class="btn   btn-success pull-left" style="margin-left:20px;">发 送</button>  &nbsp;&nbsp;
                        <button type="button" id="btn_savedraft" class="btn  btn-success pull-left" style="margin-left:20px;">存草稿</button>  &nbsp;&nbsp;
                        <span id="span_draftId" style="display:block"></span>
                    </div>
                </div>
                <!-- /.box-header -->
                <!-- form start -->
                <form class="form-horizontal">
                    <div class="box-body">
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-1 control-label">寄件人</label>
                            <label id="lb_aid" style="display:block"></label>
                            <div class="col-sm-10">
                                <span id="span_aid" style="display:block"></span>
                                <input type="email" class="form-control" id="txt_sendermail" placeholder="Select Email" readonly="readonly">

                            </div>
                        </div>


                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-1 control-label">收件人</label>

                            <div class="col-sm-10">
                                <input type="email" class="form-control" id="txt_recivermail" placeholder="Reciver Email">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-1 control-label">主 题</label>

                            <div class="col-sm-10">
                                <input type="email" class="form-control" id="txt_mailtitle" placeholder="Subject">
                            </div>
                        </div>

                    </div>
                    <!-- /.box-body -->
                    <!-- /.box-footer -->

                    <div class="box-footer">
                        <div>
                            <textarea name="description" id="description"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <!-- /.nav-tabs-custom -->
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->

</section>
<!-- /.content -->


@section scripts{
    <script src="~/Reference/scripts/CommonScript.js"></script>
    <script src="~/Reference/scripts/vue-pager.js"></script>
    <script type="text/javascript">

        window.onload = function () {
            CKEDITOR.replace('description', {
                height: 400
            });
        }

        var account_vm;
        var draftid;
        $(document).ready(function () {



            BindEditor();
            BindAccountView();
            BindTemplate();
            SetEvent();
        }
        );

        function BindEditor() {
            draftid = getQueryString("draftid");
            if (draftid == null || draftid == "") {
                return;
            }
          
            $.ajax({
                url: "/Draft/Select",
                type: "POST",
                data: {
                    mailid: draftid
                },
                success: function (result) {
                    if (result.Success) {
                        var res = result.Content;
                        $("#txt_sendermail").val(res.Tomail);
                        $("#txt_recivermail").val(res.Inmail);
                        CKEDITOR.instances['description'].setData(res.Content);
                    } else {
                        alert_danger("未发现该草稿！");
                    }
                }
            });

        }

        function BindAccountView() {
            account_vm = new Vue({
                el: "#app",
                data: {
                    AccountItems: {}
                },
                created: function () {
                    this.InitAccount();
                },
                methods: {
                    InitAccount: function () {

                        var self = this;
                        $.ajax({
                            url: "/Home/LoadAccount",
                            type: "POST",
                            success: function (result) {

                                if (result.Success) {
                                    self.AccountItems = result.Content.Data;
                                }
                                for (var i = 0; i < result.Content.Data.length; i++) {
                                    if (result.Content.Data[i].Isdefault == 1) {
                                        $("#lb_aid").val(result.Content.Data[i].Aid);
                                        $("#txt_sendermail").val(result.Content.Data[i].Account);
                                    }
                                }
                            }
                        })
                    },

                    AccountUse: function (item) {
                        $("#lb_aid").val(item.Aid);
                        $("#txt_sendermail").val(item.Account);

                    }

                }

            });
        }

        function SetEvent() {

            $("#btn_send").click(function () {

                $.ajax({
                    url: "/Home/SendMail",
                    type: "POST",
                    data: {
                        sendermail: $("#txt_sendermail").val(),
                        senderpwd: $("#txt_senderpwd").val(),
                        recivermail: $("#txt_recivermail").val(),
                        content: CKEDITOR.instances['description'].getData(),
                        mailtitile: $("#txt_mailtitle").val()
                    },
                    success: function (result) {
                        if (result.Success) {
                            alert_success("邮件发送成功！");
                        } else {
                            alert_danger("邮件发送失败！");
                        }
                    }
                });


            });


            $("#btn_savedraft").click(function () {

                var Tomail = $("#txt_sendermail").val();
                var Inmail = $("#txt_recivermail").val();
                var Content = CKEDITOR.instances['description'].getData();
                var Subject = $("#txt_mailtitle").val();
                var AccountId = $("#span_aid").val();

                $.ajax({
                    url: "/Draft/Add",
                    type: "POST",
                    data: {
                        Tomail: Tomail,
                        Inmail: Inmail,
                        Content: Content,
                        Subject: Subject,
                        AccountId:AccountId
                    },
                    success: function (result) {
                        if (result.Success) {
                            alert_success("保存成功！");
                        } else {
                            alert_danger("保存失败！");
                        }
                    }
                });

            });
        }

        function BindTemplate() {

            temp_vm = wui.pagination({
                el: "#App_Temp",
                url: "/Template/ListTemp",
                query: function () {

                },
                methods: {
                    useitem: function (item) {
                        CKEDITOR.instances['description'].setData(item.TempContent);
                    }
                },
                showTips: alert_danger
            });
        }

    </script>
    }