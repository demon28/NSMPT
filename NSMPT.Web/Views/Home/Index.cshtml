
@{
    ViewBag.Title = "Index";

}


@section HtmlHead{


    <link href="~/Reference/css/nsmpt.css" rel="stylesheet" />
}



@section Pageheader{
    <h1>
        <small>  Write E-Mail</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Mailbox</li>
    </ol>

}
<section class="content">

    <div class="row">
        <div class="col-md-3">
            <div class="box box-info" id="app">

                <div class="box-header with-border">
                    <h3 class="box-title">User Account</h3>

                </div>

                <div class="box-body table-responsive ">

                    <ul class="list-group">
                        <li class="list-group-item" v-for="item in AccountItems">

                            <b>{{item.Account}}</b>&nbsp;&nbsp;

                            <button type="button" class="btn bg-primary  btn-xs pull-right " v-on:click="AccountUse(item)">Use</button>
                        </li>

                    </ul>


                </div>
                <!-- /.box-body -->
            </div>
            <!-- /.box -->
            <!-- About Me Box -->

            <div class="box box-warning">
                <div class="box-header">
                    <h3 class="box-title">Template List</h3>

                    <div class="box-tools pull-right">
                        <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>

                </div>
                <!-- /.box-header -->
                <div class="box-body table-responsive " id="App_Temp">
                    <table class="table table-hover" id="tab_contact">
                        <tbody>
                            <tr>

                                <th>Name</th>
                                <th class="text-right"></th>
                            </tr>
                            <tr v-for="(item,index) in Data">

                                <td>

                                    <a v-on:click="useitem(item)" style="cursor:pointer;"> {{item.TempName}}</a>
                                </td>
                                <td class="text-right">
                                    <button type="button" class="btn bg-purple  btn-xs " v-on:click="useitem(item)">Use</button>  &nbsp; &nbsp;
                                </td>
                            </tr>

                        </tbody>
                    </table>
                </div>
                <div class="box-footer">

                </div>
                <!-- /.box-body -->
            </div>

            <!-- /.box -->
        </div>
        <!-- /.col -->
        <div class="col-md-9">



            <!-- Custom Tabs -->
            <div class="nav-tabs-custom">
                <ul class="nav nav-tabs pull-right">
                    <li><a href="#tab_3" data-toggle="tab">定 时</a></li>
                    <li><a href="#tab_2" data-toggle="tab">群 发</a></li>
                    <li class="active"><a href="#tab_1" data-toggle="tab">普 通</a></li>

                    <li class="pull-left header"><i class="fa fa-envelope "></i>Let's Get It</li>
                </ul>
                <div class="tab-content">

                    <div class="tab-pane active" id="tab_1">



                        <div class="form-inline" style="margin-top:10px">
                            <button type="button" id="btn_send" class="btn   btn-success pull-left" style="margin-left:20px;">    <i class="fa fa-send"></i> &nbsp;&nbsp; 发 送</button>  &nbsp;&nbsp;
                            <button type="button" id="btn_savedraft" class="btn  btn-success pull-left" style="margin-left:20px;">存草稿</button>  &nbsp;&nbsp;

                            <span id="span_draftId" style="display:block"></span>
                        </div>


                        <form class="form-horizontal" style="margin-top:30px">

                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-1 control-label">寄件人</label>
                                <label id="lb_aid" style="display:block"></label>
                                <div class="col-sm-10">

                                    <input type="email" class="form-control input-sm" id="txt_sendermail" placeholder="Select Email" readonly="readonly">

                                </div>
                            </div>


                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-1 control-label">收件人</label>

                                <div class="col-sm-10">
                                    <input type="email" class="form-control input-sm" id="txt_recivermail" placeholder="Reciver Email">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-1 control-label">主 &nbsp;&nbsp; 题</label>

                                <div class="col-sm-10">
                                    <input type="email" class="form-control input-sm" id="txt_mailtitle" placeholder="Subject">


                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputEmail3" class="col-sm-1 control-label">附 &nbsp;&nbsp; 件</label>
                                <div id="from_fileupload">
                                    <div class="btn btn-default btn-file  pull-left" style="margin-left:15px">
                                        <i class="fa fa-paperclip"></i> Attachment
                                        <input type="file" name="attachment" id="file_attachment">
                                    </div>


                                    <ul class="list-group col-xs-6" style="margin-left:15px" id="ul_attachment"></ul>
                                </div>
                            </div>

                            <!-- /.box-body -->
                            <!-- /.box-footer -->
                           

                            <div class="form-horizontal">
                                <textarea name="description" id="description"></textarea>
                            </div>

                        </form>


                    </div>
                    <!-- /.tab-pane -->
                    <div class="tab-pane" id="tab_2">

                    </div>
                    <!-- /.tab-pane -->
                    <div class="tab-pane" id="tab_3">

                    </div>
                    <!-- /.tab-pane -->
                </div>
                <!-- /.tab-content -->
            </div>
            <!-- /.nav-tabs-custom -->
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->

</section>
<!-- /.content -->


@section scripts{
    <script src="~/Reference/adminLTE/bower_components/ckeditor/ckeditor.js"></script>
    <script src="~/Reference/scripts/CommonScript.js"></script>
    <script src="~/Reference/scripts/vue-pager.js"></script>


    <script src="~/Reference/scripts/jquery.form.min.js"></script>
    <script type="text/javascript">

        window.onload = function () {
            CKEDITOR.replace('description', {
                filebrowserImageUploadUrl: "/Template/UploadImage?type=Images",
                height: 400
            });
        }

        var account_vm;
        var draftid;
        var filelist = new Array();
        var fileuploaded = new Array()

        $(document).ready(function () {



            BindEditor();
            BindAccountView();
            BindTemplate();
            SetEvent();
        }
        );

        function BindEditor() {
            draftid = getQueryString("draftid");
            if (draftid == null || draftid == "") {
                return;
            }
            var content;
            $.ajax({
                url: "/Draft/Select",
                type: "POST",
                data: {
                    mailid: draftid
                },
                success: function (result) {
                    if (result.Success) {
                        var res = result.Content;
                        $("#txt_sendermail").val(res.Tomail);
                        $("#txt_recivermail").val(res.Inmail);
                        $("#txt_mailtitle").val(res.Subject);
                        content = res.Content;
                        CKEDITOR.instances['description'].setData(content);


                    } else {
                        alert_danger("未发现该草稿！");
                    }
                }
            });

        }

        function BindAccountView() {
            account_vm = new Vue({
                el: "#app",
                data: {
                    AccountItems: {}
                },
                created: function () {
                    this.InitAccount();
                },
                methods: {
                    InitAccount: function () {

                        var self = this;
                        $.ajax({
                            url: "/Home/LoadAccount",
                            type: "POST",
                            success: function (result) {

                                if (result.Success) {
                                    self.AccountItems = result.Content.Data;
                                }
                                for (var i = 0; i < result.Content.Data.length; i++) {
                                    if (result.Content.Data[i].Isdefault == 1) {
                                        $("#lb_aid").val(result.Content.Data[i].Aid);
                                        $("#txt_sendermail").val(result.Content.Data[i].Account);
                                    }
                                }
                            }
                        })
                    },

                    AccountUse: function (item) {
                        $("#lb_aid").val(item.Aid);
                        $("#txt_sendermail").val(item.Account);

                    }

                }

            });
        }

        function SetEvent() {

            $("#btn_send").click(function () {


                var Tomail = $("#txt_sendermail").val();
                var Inmail = $("#txt_recivermail").val();
                var Content = CKEDITOR.instances['description'].getData();
                var Subject = $("#txt_mailtitle").val();
                var AccountId = $("#lb_aid").val();

                if (Inmail == "" || Inmail == null) {

                    alert_danger("请填写收件人！");
                    return;
                }
                if (Subject == "" || Subject == null) {

                    alert_danger("主题内容不能为空！");
                    return;
                }
                if (Content == "" || Content == null) {

                    alert_danger("邮件内容不能为空！");
                    return;
                }

                  var dialog = bootbox.dialog({
                                    title: '邮件发送中...',
                                    message: '<p><i class="fa fa-spin fa-spinner"></i> Loading...</p>'
                                });

                $.ajax({
                    url: "/Home/SendMail",
                    type: "POST",
                    data: {
                        MailId: draftid,
                        Tomail: Tomail,
                        Inmail: Inmail,
                        Content: Content,
                        Subject: Subject,
                        AccountId: AccountId
                    },
                    success: function (result) {

                        dialog.modal('hide');
                        if (result.Success) {
                            alert_success("邮件发送成功！");
                        } else {
                            alert_danger(result.Message);
                        }
                    }
                });


            });


            $("#btn_savedraft").click(function () {

                var action = "/Draft/Update";
                draftid = getQueryString("draftid");
                console.log(draftid);

                if (draftid == null || draftid == "") {
                    action = "/Draft/Add";
                }

                var Tomail = $("#txt_sendermail").val();
                var Inmail = $("#txt_recivermail").val();
                var Content = CKEDITOR.instances['description'].getData();
                var Subject = $("#txt_mailtitle").val();
                var AccountId = $("#lb_aid").val();


                if (Subject == "" || Subject == null) {

                    alert_danger("主题内容不能为空！");
                    return;
                }
                if (Content == "" || Content == null) {

                    alert_danger("草稿内容不能为空！");
                    return;
                }

                $.ajax({
                    url: action,
                    type: "POST",
                    data: {
                        MailId: draftid,
                        Tomail: Tomail,
                        Inmail: Inmail,
                        Content: Content,
                        Subject: Subject,
                        AccountId: AccountId
                    },
                    success: function (result) {
                        if (result.Success) {
                            alert_success("保存成功！");
                        } else {
                            alert_danger("保存失败！");
                        }
                    }
                });

            });


            $("#file_attachment").change(function () {

                var lengli = $("#ul_attachment li").length;
                var uploadFile = $('#file_attachment')[0].files[0];
              

                if (lengli >= 5) {
                    alert_danger("单次仅能发送5个附件");
                    return;
                }

                if (uploadFile.size >= 19653562) {
                    alert_danger("单个文件请不要超过15M");
                    return;
                }

                if (filelist.indexOf(uploadFile.name) > -1) {
                    alert_danger("附件已存在,请重新选择附件");
                    return;
                }


                //添加到上传数组
                filelist.push(uploadFile.name);
             

                var index1 = uploadFile.name.lastIndexOf(".");
                var index2 = uploadFile.name.length;
                var suffix = uploadFile.name.substring(index1 + 1, index2);
                var filename = uploadFile.name.substring(0, index1);

                var element = "<li id='li_file_" + filename + "' class=\"list-group-item\" style=\"padding:5px 10px\">";
                element += "      <span>";
                element += "      <i class=\"fa fa-paperclip\"></i>";
                element += "                   <small>  " + uploadFile.name + "</small>";
                element += "                 <a style=\"margin-left:20px; cursor:default\" onclick=\"removefile('li_file_" + filename + "','" + uploadFile.name + "')\"><small>删除</small></a>";

                if (suffix == "png" || suffix == "jpg") {
                    element += "                   <a id='a_insert_contnet_"+filename+"' style=\"margin-left:20px; cursor:default\" onclick='insert2contnet(this.name)'><small>添加到正文</small></a>";
                }

                element += "                   <small id='small_progress_" + filename + "' class=\"pull-right\" style=\"display:block\">0%</small>";
                element += "                </span>";
                element += "                 <div id='div_progress_" + filename + "' class=\"progress xxs \" style=\"margin-bottom:0px;display:block\">";
                element += "                    <div id='green_div_progress_" + filename + "' class=\"progress-bar progress-bar-green\" style=\"width: 0%\" role=\"progressbar\"  aria-valuenow=\"20\" aria-valuemin=\"0\" aria-valuemax=\"100\">";
                element += "                     <span id='span_progress_" + filename + "' class=\"sr-only\">0% Complete</span>";
                element += "             </div>";
                element += "             </div>";
                element += "     </li>";


                $("#ul_attachment").append(element);


                
                $("#from_fileupload").ajaxSubmit({
                    url: '/Home/UploadAttachment',
                    type: 'post',
                    dataType: 'json',
                    processData: false,
                    contentType: false,
                    success: function (result) {

                        if (suffix == "png" || suffix == "jpg")
                        {
                                  document.getElementById("a_insert_contnet_" + filename).name = result.Content;
                        }
                        
                    },
                    xhr: function () {
                        var xhr = new XMLHttpRequest();
                        //使用XMLHttpRequest.upload监听上传过程，注册progress事件，打印回调函数中的event事件
                        xhr.upload.addEventListener('progress', function (e) {

                            //loaded代表上传了多少
                            //total代表总数为多少

                            var baserate = (e.loaded / e.total).toFixed(2);



                            var progressRate = baserate * 100 + '%';


                            var progress_node = document.getElementById("div_progress_" + filename);   //进度条父节点
                            var progress_node_div = document.getElementById("green_div_progress_" + filename);


                            var progress_node_span = document.getElementById("span_progress_" + filename);
                            var progress_value = document.getElementById("small_progress_" + filename);

                            //通过设置进度条的宽度达到效果
                            progress_node_div.style.width = progressRate;

                            progress_node_span.innerHTML = progressRate;
                            progress_value.innerHTML = progressRate;


                            //上传完成
                            if (e.loaded == e.total) {
                                progress_node.style.display = "none";
                                progress_value.style.display = "none";

                            }
                        })

                        return xhr;
                    }
                })


            });
        }

        //移除附件
        function removefile(el, filename) {

            var _element = document.getElementById(el);
            var _parentElement = _element.parentNode;
            if (_parentElement) {
                _parentElement.removeChild(_element);
            }

            var index = filelist.indexOf(filename);
            if (index > -1) {
                filelist.splice(index, 1);
            }
            
        }

        //添加图片到正文
        function insert2contnet(imgurl) {

            var element = " <img src='" + imgurl + "' />";
             CKEDITOR.instances['description'].insertHtml(element);
        }


        function BindTemplate() {

            temp_vm = wui.pagination({
                el: "#App_Temp",
                url: "/Template/ListTemp",
                query: function () {

                },
                methods: {
                    useitem: function (item) {
                        CKEDITOR.instances['description'].setData(item.TempContent);
                    }
                },
                showTips: alert_danger
            });
        }

    </script>
}